<!-- < msreadoutspan class="msreadout-word-highlight">发</msreadoutspan> -->
<!-- http://192.168.1.13:8000/edgeviewer.html -->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电子书阅读器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jschardet/1.4.1/jschardet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
    <script src="https://chenxiaohai18.github.io/common.js"></script>

    <style>
        :root {
            --main-color: #333333;
            --main-bg-color: #f5f5f7;
            --before-bg: #0d0d0d;
            --chapter-info-color: #333;
            --chapter-list-color: white;
            --highlight-line-color: rgba(0, 0, 0, 0.115);

            --bg-color: #ffffff;
            --text-color: #000000;
            --switch-bg: #f0f0f0;
            --switch-handle: #ffffff;
            --switch-border: #cccccc;
            --transition: all 0.3s ease;

            --bar-bg-color: #434343;
        }

        .theme-dark {
            --main-color: #333333;
            --main-bg-color: black;
            --before-bg: #0d0d0d;
            --chapter-info-color: rgba(255, 255, 255, 0.3);
            --chapter-list-color: white;
            --highlight-line-color: rgba(255, 255, 255, 0.8);

            --bg-color: #121212;
            --text-color: #ffffff;
            --switch-bg: #333333;
            --switch-handle: #222222;
            --switch-border: #555555;

            --bar-bg-color: #272727;
        }

        body {
            margin: 0;
            height: 100vh;
            color: var(--main-color);
            background: var(--main-bg-color);
            font-family: -apple-system, sans-serif;
        }

        .highlight {
            padding: 1px 0px;
            background-color: yellow;
        }

        .line-selection {
            padding: 1px 0px;
            background-color: var(--highlight-line-color);
        }


        .disabled {
            cursor: not-allowed;
            opacity: 0.6;
            text-decoration: none;
            color: red;
        }

        .file-input-div {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .custom-file-input {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        /* 隐藏原生输入框 */
        .custom-file-input input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            height: 100%;
            width: 100%;
        }

        /* 自定义样式 */
        .custom-file-label {
            width: 480px;
            display: inline-block;
            padding: 8px 20px;
            text-align: center;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        /* 未选择文件时的提示文字 */
        .file-name::before {
            content: "点击选择txt、epub文件";
            color: white;
        }

        .file-name:hover::after {
            opacity: 1;
            content: '';
        }

        .main-div {
            position: relative;
        }

        .padviewer {
            position: absolute;
            display: none;
            z-index: 1;
        }

        .viewer {
            display: none;
            line-height: 35px;
            letter-spacing: 1px;
        }

        label {
            display: inline-block;
            margin-bottom: 15px;
            font-size: medium;
            align-items: center;
            text-align: center;
        }

        .display-type {
            margin-left: 10px;
            margin-right: 10px;
            accent-color: #007bff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .page-title {
            border-left: 1px solid red;
            padding-left: 5px;
            position: absolute;
            width: 100%;
            color: #ddd;
            font-size: small;
            margin-top: 0px;
            z-index: 2;
        }

        .page-tip {
            width: 100%;
            color: #ddd;
            font-size: small;
            margin-top: 3px;
            padding-right: 5px;
            text-align: right;
        }

        .page-index {
            width: 100%;
            color: #ddd;
            font-size: small;
            margin-top: -50px;
            text-align: center;
        }

        .reader-container {
            width: 90%;
            height: 95vh;
            margin: 20px auto;
            margin-bottom: 0;
            padding: 80px 70px;
            background: white;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            overflow-y: auto;
            column-count: 2;
            column-gap: 140px;
            column-fill: auto;
            column-rule: 0px solid #eee;
            overflow: hidden;
        }


        .reader-container::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 20%;
            height: 60%;
            width: 1px;
            background-color: var(--before-bg, '#eee');
        }

        .content {
            line-height: 35px;
            letter-spacing: 3px;
            font-size: 16px;
            color: #333;
            text-align: justify;
            hyphens: auto;
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            orphans: 3;
            widows: 3;
            text-indent: 2;
        }

        /* 禁止元素跨栏  */
        h1,
        h2,
        h3,
        p,
        img {
            /**break-inside: avoid;*/
            margin-bottom: 1.2em;
        }


        p {
            text-indent: var(--p-text-indent, '0em');
            text-align: justify;
            text-justify: inter-word;
            hyphens: auto;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 0px;
        }

        ::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 4px;
        }


        .sub-title {
            color: red;
        }
    </style>



    <!-- 播放控件 -->
    <style>
        .tip-info {
            top: 0px;
            bottom: 0px;
            width: auto;
            height: auto;
            z-index: 3;
            position: fixed;
            display: flex;
            cursor: pointer;
            color: red;
        }


        /* 默认播放条（图一） */
        .default-bar {
            width: 190px;
            height: 35px;
            z-index: 3;
            position: fixed;
            left: 0px;
            bottom: 0px;
            display: flex;
            visibility: hidden;
            align-items: center;
            background: rgba(255, 255, 255, 0);
            cursor: pointer;
            transition: transform 0.2s;
            border: 0.5px solid rgba(0, 0, 0, 0);
            background-color: var(--bar-bg-color);
        }

        .play-pos {
            height: 30px;
            width: 40px;
            color: rgba(255, 0, 0, 0.563);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .play-pos:hover {
            background: rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .play-btn {
            width: 50px;
            height: 30px;
            min-width: 50px;
            font-size: 13px;
            color: white;
            border: none;
            background: red;
        }

        .play-btn:hover {
            transform: scale(1.02);
            transition: all 0.2s ease;
        }

        .chapter-info {
            color: #ffffff50;
            padding-left: 20px;
            font-size: 13px;
            flex-grow: 1;
            height: 30px;
            display: flex;
            align-items: center;
        }

        .chapter-info:hover {
            background: rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }


        /* 书籍目录容器（图二） */
        .book-container {
            width: 100%;
            z-index: 3;
            display: none;
            position: fixed;
            left: 0px;
            bottom: 35px;
            background: var(--chapter-list-color);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 显示时动画 */
        .show-detail {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 书籍标题 */
        .book-title {
            color: #333;
            font-size: 13px;
            font-weight: bold;
            padding: 12px 25px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.073);
        }

        /* 章节列表 */
        .chapter-list {
            width: 100%;
            list-style: none;
            padding: 0px;
            margin: 0 0 5px 0;
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        /* 隐藏 Chrome、Safari 和 Opera 的滚动条 */
        .chapter-list::-webkit-scrollbar {
            display: none;
        }

        .chapter-item {
            font-size: 11px;
            padding: 12px 25px;
            border-bottom: 1px solid #eeeeee6b;
            color: #333;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .chapter-item:hover {
            background-color: #f5f5f5;
        }

        .chapter-item.selected {
            background-color: #ffd90051;
            color: #333;
            font-weight: 500;
        }
    </style>

    <script>
        let isDetailShow = false;

        function toggleDetail() {
            const container = document.getElementById('bookDetail');
            isDetailShow = !isDetailShow;
            container.classList.toggle('show-detail', isDetailShow);
            if (selectItem != undefined) selectItem.scrollIntoView({ block: 'center' });
        }

        function playPos() {
            // var highlight = document.getElementsByClassName("highlight")[0];
            // if (highlight == undefined) return;
            // highlight.scrollIntoView({ block: 'center' });

            var items = document.getElementsByClassName("msreadout-word-highlight");
            if (items && items.length > 0) {
                var element = items[0];
                element.scrollIntoView({ block: 'center' });
            }
        }

        // 点击外部关闭
        document.addEventListener('click', (e) => {
            const container = document.getElementById('bookDetail');
            if (!e.target.closest('.default-bar') &&
                !e.target.closest('.book-container')) {
                container.classList.remove('show-detail');
                isDetailShow = false;
            }
        });

        // 初始化书籍数据
        function initBookData(bookData) {
            const container = document.getElementById('bookDetail');
            container.querySelector('.book-title').textContent = `${bookData.title}`;

            const list = container.querySelector('.chapter-list');
            list.innerHTML = bookData.chapters.map((chap, index) =>
                `<li class="chapter-item" >${chap}</li>`
            ).join('');

            // 添加章节点击事件
            const items = list.querySelectorAll('.chapter-item');
            items.forEach((item, index) => {
                item.addEventListener('click', function () {
                    items.forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    document.querySelector('.chapter-info').textContent = this.textContent;
                    document.getElementById('bookDetail').classList.remove('show-detail');
                    isDetailShow = false;
                    if (index === 0) {
                        window.scrollTo({
                            top: 0,
                            behavior: 'auto'
                        });
                    } else {
                        var a = document.getElementById('chapter-' + index++);
                        a.scrollIntoView({
                            // behavior: 'smooth',
                            block: 'start'
                        });
                    }


                });

                // 默认选中第一个章节
                if (index === 0) {
                    item.classList.add('selected');
                    document.querySelector('.chapter-info').textContent = bookData.chapters[0];
                }
            });
        }

        let isPlaying = false;
        function playOnload() {
            const playBtn = document.querySelector('.play-btn');
            playBtn.addEventListener('click', function () {
                setPlaylbl(!isPlaying);
                if (isPlaying) {
                    if (speechSynthesis.speaking || speechSynthesis.paused) {
                        speechSynthesis.resume();
                        return;
                    }
                    startReading(null, 0);
                } else {
                    stopReading();
                }
            });
        }

        function setPlaylbl(_isPlaying) {
            isPlaying = _isPlaying;
            document.querySelector('.play-btn').textContent = isPlaying ? '暂 停' : '继 续';
        }



    </script>

</head>
<script>
    var cursorIndex;
    function hideCursor() {
        cursorIndex++;
        if (cursorIndex > 30) {
            // vTitle.style.visibility = 'hidden';
            pageTip.style.visibility = 'hidden';
            lblPageIndex.style.visibility = 'hidden';
            document.body.style.cursor = 'none';
        }
    }
    function resetCursorVisibility(event) {
        if (defDisplayType != undefined && !defDisplayType.checked) {
            // vTitle.style.visibility = 'visible';
            pageTip.style.visibility = 'visible';
            lblPageIndex.style.visibility = 'visible';
        }
        document.body.style.cursor = 'auto';
        cursorIndex = 0;
    }
    document.addEventListener('mousemove', resetCursorVisibility);


    var pagePlayIndex = 0; // 当前播放位置索引
    var pageIndex = 0; // 当前显示页索引
    var pageTotal = 0; // 总页数
    var scrollContainer;
    var content;
    var pageWidth;
    var pageTip;
    function loadPad() {
        scrollContainer = document.getElementsByClassName("reader-container")[0];
        var vWidth = content.getBoundingClientRect().width;
        pageWidth = scrollContainer.offsetWidth + 140 - 140;
        pageTotal = parseInt(vWidth / pageWidth);
        displayPageTip();
        keyEvent();
        // setInterval(executeEverySecondPad, 100);
    }

    var iskeydown = false;
    function keyEvent() {
        if (iskeydown) return;
        iskeydown = true;
        window.addEventListener('keydown', function (event) {
            resetCursorVisibility();
            switch (event.key) {
                case 'ArrowUp':
                case 'ArrowLeft':
                    pageIndex--;
                    if (pageIndex < 0) pageIndex = 0;
                    displayPageTip();
                    goPage(pageIndex);
                    break;
                case 'ArrowDown':
                case 'ArrowRight':
                    pageIndex++;
                    if (pageIndex > pageTotal) pageIndex = pageTotal;
                    displayPageTip();
                    goPage(pageIndex);
                    break;
            }

        });
    }

    function displayPageTip() {
        var pagePlayIndexlbl = pagePlayIndex + 1;
        if (pagePlayIndexlbl < 10) pagePlayIndexlbl = '0' + pagePlayIndexlbl;
        var pageIndexlbl = pageIndex + 1;
        if (pageIndexlbl < 10) pageIndexlbl = '0' + pageIndexlbl;
        var pageTotallbl = pageTotal + 1;
        if (pageTotallbl < 10) pageTotallbl = '0' + pageTotallbl;
        if (pageIndex == pagePlayIndex) {
            pageTip.innerText = pageIndexlbl + ' : ' + pageTotallbl;
        } else {
            pageTip.innerText = pagePlayIndexlbl + ' : ' + pageIndexlbl + ' : ' + pageTotallbl;
        }
    }

    // function executeEverySecondPad() {
    //     hideCursor();
    //     pageWidth = scrollContainer.offsetWidth + 140 - 140;
    //     pageTotal = parseInt(content.getBoundingClientRect().width / pageWidth);
    //     displayPageTip();
    //     var items = document.getElementsByClassName("msreadout-word-highlight");
    //     if (items && items.length > 0) {
    //         var element = items[0];
    //         var index = parseInt(element.offsetLeft / pageWidth);
    //         if (pagePlayIndex == index || element.offsetLeft % pageWidth < 80) return;
    //         if (Math.abs(index - pagePlayIndex) != 1) {
    //             pageIndex = index - 1;
    //         } else if (pageIndex + 1 != index) {
    //             pagePlayIndex = index;
    //             return;
    //         }
    //         pagePlayIndex = index;
    //         pageIndex++;
    //         goPage(index);
    //     }
    // }

    function goPage(index) {
        var left = (index * (pageWidth));
        scrollContainer.scrollTo({
            left: left,
            behavior: 'auto',
        });

    }

    // 监听浏览器窗口宽度变化
    window.addEventListener('resize', function () {
        loaded();
    });

    function isMobileDevice() {
        return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1) || (window.innerWidth > 0 && window.innerWidth < 768);
    }
    function loaded() {
        var isMobile = isMobileDevice();
        var paddWidth = window.innerWidth / 10;
        if (isMobile) {
            document.body.style.padding = 20 + 'px';
            document.body.style.paddingTop = 50 + 'px';
        } else {
            document.body.style.padding = paddWidth + 'px';
        }

        setInterval(executeEverySecond, 100);
    }
    function executeEverySecond() {
        // hideCursor();
        var items = document.getElementsByClassName("msreadout-word-highlight");
        if (items && items.length > 0) {
            var element = items[0];
            var rect = element.getBoundingClientRect();
            if (rect.top > window.innerHeight * (3 / 4) && rect.top < window.innerHeight * 2) {
                window.scrollTo({
                    top: window.scrollY + (window.innerHeight / 2) + 50,
                    behavior: 'auto',
                });
                /**
                element.scrollIntoView({
                    //behavior: 'smooth',
                    block: 'center'
                });
                **/
            }
        }
    }

    const rootElement = document.documentElement;
    function init() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            rootElement.classList.add('theme-dark');
            document.getElementsByClassName("display-type")[3].checked = true;
        }

        const displayType = localStorage.getItem('display-type');
        if (displayType === '2') {
            document.getElementsByClassName("display-type")[1].checked = true;
        }

    }
    function switchTheme() {
        const isDark = rootElement.classList.contains('theme-dark');
        const isDarkClick = document.getElementsByClassName("display-type")[3].checked;
        if (isDark == isDarkClick) return;
        rootElement.classList.toggle('theme-dark', !isDark);
        localStorage.setItem('theme', isDark ? 'light' : 'dark');
    }

    function switchDisplay() {
        var displayType = '1';
        if (document.getElementsByClassName("display-type")[1].checked) {
            displayType = '2';
        }
        localStorage.setItem('display-type', displayType);
    }

    var defDisplayType; // 默认显示
    var defThemeType; // 默认主题
    var viewer; // 默认显示
    var padviewer; // 双栏显示
    var filePageSize; // 文件总页数
    var lblPageIndex;
    // var vTitle;
    var fileName;
    window.onload = function () {
        init();
        playOnload();
        defDisplayType = document.getElementsByClassName("display-type")[0];
        if (isMobileDevice()) {
            document.getElementsByClassName("lbldisplay")[0].style.display = 'none';
            document.getElementsByClassName("lbldisplay")[1].style.display = 'none';
            document.getElementsByClassName("custom-file-label")[0].style.width = '300px';
        }
        defThemeType = document.getElementsByClassName("display-type")[2];
        // vTitle = document.getElementsByClassName("page-title")[0];
        pageTip = document.getElementsByClassName("page-tip")[0];
        viewer = document.getElementsByClassName("viewer")[0];
        padviewer = document.getElementsByClassName("padviewer")[0];
        content = document.getElementsByClassName("content")[0];
        lblPageIndex = document.getElementsByClassName("page-index")[0];
        var inputElementDiv = document.getElementsByClassName("file-input-div")[0];
        var inputElement = document.getElementById("real-input");
        inputElement.addEventListener('change', function (e) {
            inputElementDiv.style.display = "none";
            var file = e.target.files[0];
            fileName = file.name;
            var fileType = file.type;
            // if (defDisplayType.checked) vTitle.style.display = 'none';
            // vTitle.innerText = fileName;
            filePageSize = parseInt((file.size) / 424000);
            if (parseInt((file.size) % 424000)) filePageSize++;
            var pageIndeHtml = '';
            for (var i = 1; i <= filePageSize; i++) {
                if (i == 1) {
                    pageIndeHtml += '<a href="#" class="disabled" onclick="clickIndex(event,' + i + ');">' + i + '</a>&nbsp;&nbsp;&nbsp;';
                } else {
                    pageIndeHtml += '<a href="#" onclick="clickIndex(event,' + i + ');">' + i + '</a>&nbsp;&nbsp;&nbsp;';
                }
            }
            lblPageIndex.innerHTML = pageIndeHtml;
            if ('text/plain' == fileType) {
                readTxt(e.target.files[0]);
            } else if ('application/epub+zip' == fileType) {
                if (window.FileReader) {
                    var reader = new FileReader();
                    reader.onload = openBook;
                    reader.readAsArrayBuffer(file);
                }
            }
        });
        function readTxt(file) {
            var fileType = file.type;
            const reader = new FileReader();
            reader.onload = async function (e) {
                var data = e.target.result;
                if (data.indexOf('的') < 0) {
                    reader.readAsText(file, 'utf-8');
                    return;
                }
                replaceKeywordTxt(data);
                showData();
            };
            reader.readAsText(file, 'gbk');
        }
        function replaceKeywordTxt(txt) {

            try {
                txt = replaceAllKeyWord(txt);
            } catch (e) {
                txt = txt.replaceAll('j8', '肉棒').replaceAll('J8', '肉棒').replaceAll('jiba', '肉棒').replaceAll('鸡巴', '肉棒').replaceAll('阴茎', '肉棒').replaceAll('guntang', '滚烫').replaceAll('yindao', '阴道').replaceAll('yinchun', '阴唇').replaceAll('taonong', '套弄').replaceAll('yuhuo', '欲火').replaceAll('mama', '妈妈').replaceAll('zuoai', '做爱').replaceAll('yinghe', '迎合').replaceAll('yinhe', '迎合')
                    .replaceAll('ying', '硬').replaceAll('ma', '吗').replaceAll('xie', '泄').replaceAll('le', '了').replaceAll('chou', '抽').replaceAll('cha', '插').replaceAll('fang', '房').replaceAll('ru', '乳').replaceAll('luan', '乱').replaceAll('lun', '伦').replaceAll('kou', '口').replaceAll('jiao', '交')
                    .replaceAll('nang', '囊').replaceAll('tao', '套').replaceAll('nong', '浓').replaceAll('mei', '妹').replaceAll('jie', '姐').replaceAll('jian', '奸').replaceAll('rou', '肉').replaceAll('bang', '棒').replaceAll('cao', '操').replaceAll('xue', '穴').replaceAll('xiao', '小').replaceAll('shuang', '爽')
                    .replaceAll('si', '死').replaceAll('zi', '子').replaceAll('gong', '宫').replaceAll('gui', '龟').replaceAll('tou', '头').replaceAll('jing', '精').replaceAll('ye', '液').replaceAll('sao', '骚').replaceAll('dong', '洞').replaceAll('yin', '淫');
            }

            // 类似乱换行的问题 "姐姐从小\r\r\n漂亮聪明"
            /*
            txt = txt.replace(/([\u4e00-\u9fa5])\r\r\n/g, '$1');
            txt = txt.replace(/([\u4e00-\u9fa5])\n\n/g, '$1');
            txt = txt.replace(/([\u4e00-\u9fa5])\n/g, '$1');
            */
            txt = txt.replaceAll('※', '');
            txt = txt.replaceAll('-', '');
            txt = txt.replaceAll('…', '');
            txt = txt.replaceAll('—', '');


            //const chapterPattern = /^第([零一二三四五六七八九十百千万\d]+)([章部回卷])\s*([^$\n]*)/;
            const chapterPattern = /第([零一二三四五六七八九十百千万\d]+)([章部回卷])\s*([^$\n]*)/;

            var chapters = ['开始阅读'];
            var index = 1;

            htmlELs = txt.split('\n')
                .map(line => line.trim())     // 去除首尾空格
                .filter(line => line.length > 0) // 过滤空行
                .map(line => line.indexOf('自带浏览器') < 0 ? line : '')
                .map(line => line.indexOf('谷歌浏览器') < 0 ? line : '')
                .map(line => line.indexOf('字数：') < 0 ? line : '')
                .map(line => line.indexOf('作者：') < 0 ? line : '')
                .map(line => line.indexOf('最新网址') < 0 ? line : '')
                .map(line => line.indexOf('&xFF2D;') < 0 ? line : '')
                .map(line => line.indexOf('&ｂ２０２１') < 0 ? line : '')
                .map(line => {
                    if (!chapterPattern.test(line) || line.length > 20) {
                        return line;
                    } else {
                        chapters.push(line);
                        return '<span id="chapter-' + index++ + '" class="sub-title">' + line + '</span>';
                    }
                })
                .map(line => '<p>' + line + '</p>');

            var bookData = {
                title: fileName.substring(0, fileName.lastIndexOf('.')),
                chapters: chapters,
            };

            initBookData(bookData);

        }

        async function openBook(e) {
            var book = ePub();
            var bookData = e.target.result;
            book.open(bookData);
            const nav = await book.loaded.navigation;
            const toc = nav.toc;
            var data = '';
            for (let i = 0; i < toc.length; i++) {
                var item = toc[i];
                const spineItem = book.spine.get(item.href);
                const htmlContent = await spineItem.load(book.load.bind(book));
                // console.log('[' + i + ']：' + spineItem.document.body.innerHTML);
                _contentTxt = '';
                getTextNodes(spineItem.document.body);
                data += _contentTxt;
                // console.log(_content);
            }
            htmlELs = data.split('\n')
                .map(line => line.trim())     // 去除首尾空格
                .filter(line => line.length > 0) // 过滤空行
                .map(line => '<p>' + line + '</p>');
            showData()
        }
    }
    var htmlELs;
    var fileIndex = 1;
    var pageTarget;
    function clickIndex(event, index) {
        pageIndex = 0;
        pagePlayIndex = 0;
        pageTotal = 0;
        fileIndex = index;
        showData();
        goPage(0);

        if (pageTarget == undefined) {
            pageTarget = document.getElementsByClassName("disabled")[0];
        }
        pageTarget.classList.remove('disabled');
        pageTarget = event.target;
        pageTarget.classList.add('disabled');

    }
    function showData() {
        selectRead();
        var _htmlELs = htmlELs;
        if (!defDisplayType.checked) {
            var len = htmlELs.length;
            var page = parseInt(len / filePageSize);
            _htmlELs = htmlELs.slice(page * (fileIndex - 1), (page * fileIndex) + 1);
        }
        _htmlELs = _htmlELs.join('');
        _htmlELs = _htmlELs.replace(/([\u4e00-\u9fa5])<\/p><p>[^<]/g, '$1');
        _htmlELs = _htmlELs.replaceAll('*', '').replaceAll('＊', '').replaceAll('？', '? ').replaceAll('（', ' (').replaceAll('）', ') ').replaceAll('，', ', ').replaceAll('：', ': ').replaceAll('‘', '').replaceAll('’', '');
        // try {
        //     _htmlELs = replaceAllKeyWord(_htmlELs);
        // } catch (e) {
        //     _htmlELs = _htmlELs.replaceAll('j8', '肉棒').replaceAll('J8', '肉棒').replaceAll('jiba', '肉棒').replaceAll('鸡巴', '肉棒').replaceAll('阴茎', '肉棒').replaceAll('guntang', '滚烫').replaceAll('yindao', '阴道').replaceAll('yinchun', '阴唇').replaceAll('taonong', '套弄').replaceAll('yuhuo', '欲火').replaceAll('mama', '妈妈').replaceAll('zuoai', '做爱').replaceAll('yinghe', '迎合').replaceAll('yinhe', '迎合')
        //         .replaceAll('ying', '硬').replaceAll('ma', '吗').replaceAll('xie', '泄').replaceAll('le', '了').replaceAll('chou', '抽').replaceAll('cha', '插').replaceAll('fang', '房').replaceAll('ru', '乳').replaceAll('luan', '乱').replaceAll('lun', '伦').replaceAll('kou', '口').replaceAll('jiao', '交')
        //         .replaceAll('nang', '囊').replaceAll('tao', '套').replaceAll('nong', '浓').replaceAll('mei', '妹').replaceAll('jie', '姐').replaceAll('jian', '奸').replaceAll('rou', '肉').replaceAll('bang', '棒').replaceAll('cao', '操').replaceAll('xue', '穴').replaceAll('xiao', '小').replaceAll('shuang', '爽')
        //         .replaceAll('si', '死').replaceAll('zi', '子').replaceAll('gong', '宫').replaceAll('gui', '龟').replaceAll('tou', '头').replaceAll('jing', '精').replaceAll('ye', '液').replaceAll('sao', '骚').replaceAll('dong', '洞').replaceAll('yin', '淫');
        // }

        var playBar = document.getElementsByClassName("default-bar")[0];
        playBar.style.visibility = "visible";

        if (defDisplayType.checked || isMobileDevice()) {
            playBar.style.width = "100%";
            viewer.style.display = "block";
            viewer.innerHTML = _htmlELs;
            loaded();
        } else {
            padviewer.style.display = "block";
            content.innerHTML = _htmlELs;
            loadPad();
            document.documentElement.style.setProperty('--p-text-indent', '2em'); // 全局修改
            if (!defThemeType.checked) {
                // scrollContainer.style.setProperty('--before-bg', '#0d0d0d');
                // document.body.style.backgroundColor = 'black';
                // scrollContainer.style.backgroundColor = 'black';
                content.style.color = '#333333';
                pageTip.style.color = '#333333';
                // vTitle.style.color = '#333333';
            } else {
                // scrollContainer.style.setProperty('--before-bg', '#eee');
                // document.body.style.backgroundColor = 'white';
                // scrollContainer.style.backgroundColor = 'white';
                pageTip.style.color = '#ddd';
                // vTitle.style.color = '#ddd';
                content.style.color = '#333333';
            }
        }
    }

    var _contentTxt = '';
    function getTextNodes(node) {
        if (null == node) return;
        if (node.nodeType === Node.TEXT_NODE) {
            var txt = node.textContent.trim();
            if ('' == txt) return;  // 过滤掉不显示的内容
            // if (/^\[\d+\]$/.test(txt) || /^\(\d+\)$/.test(txt)) return;
            if (txt.length > 5) {
                txt += '\r\n';
            } else {
                txt += ' ';
            }
            _contentTxt += txt;
            return [node];
        }
        for (let i = 0; i < node.childNodes.length; i++) getTextNodes(node.childNodes[i]);
    }


    // 听书模块
    let speechSynthesis = window.speechSynthesis;
    let utterance;

    var isTrue = false;
    function getAllTextNodes(node, currNode) {
        if (currNode == null || currNode == undefined) isTrue = true;
        let textNodes = [];
        if (node.nodeType === Node.TEXT_NODE && node.parentElement.nodeName != "BUTTON" && node.parentElement.nodeName != "INPUT" && node.textContent.trim() !== '') {
            if (node.parentElement == currNode) isTrue = true;
            if (isTrue) textNodes.push(node);
        } else {
            for (let i = 0; i < node.childNodes.length; i++) {
                textNodes = textNodes.concat(getAllTextNodes(node.childNodes[i], currNode));
            }
        }
        return textNodes;
    }

    var playIndex = 0;
    var textNodes;
    function startReading(currNode, startIndex) {
        playIndex = 0;
        isTrue = false;
        textNodes = getAllTextNodes(viewer, currNode);
        readEl(textNodes[playIndex].parentElement, startIndex);
    }

    function stopReading() {
        if (speechSynthesis.speaking && !speechSynthesis.paused) {
            speechSynthesis.pause();
        }
    }

    function selectRead() {
        document.addEventListener('mouseup', function () {
            let selection = window.getSelection();
            if (selection.toString().length <= 0 || selection.toString().length > 20) return;
            stopReading();
            var repStr = '[@@@@@]';
            let range = selection.getRangeAt(0);
            range.insertNode(document.createTextNode(repStr));
            var el = selection.anchorNode.parentElement;
            if (el.className == "highlight") el = el.parentElement;
            if (el.className == "line-selection") el = el.parentElement;
            document.querySelectorAll('.line-selection').forEach(function (el) { el.parentElement.innerHTML = el.parentElement.innerText; });
            var anchorOffset = el.innerText.indexOf(repStr);
            el.innerText = el.innerText.replace(repStr, '');
            selection.removeAllRanges();
            startReading(el, anchorOffset);
        });
    }


    // 监听窗口滚动事件
    window.addEventListener('scroll', handleScroll);

    var chapterScrollYs = []
    var selectIndex = 0;
    var selectItem;

    function handleScroll() {
        const scrollY = window.scrollY || window.pageYOffset;
        const scrollX = window.scrollX || window.pageXOffset;


        if (chapterScrollYs.length == 0) {
            document.querySelectorAll('.sub-title').forEach(function (el) {
                chapterScrollYs.push(el.offsetTop);
            })
            return;
        }

        var index = 0;
        for (let i = 0; i < chapterScrollYs.length; i++) {
            if (scrollY < chapterScrollYs[i] - 100) {
                index = i;
                break;
            }
        }

        if (selectIndex == index) return;

        selectIndex = index;
        const items = document.querySelectorAll('.chapter-item');
        items.forEach(i => i.classList.remove('selected'));

        var item = items[index];
        selectItem = item;
        item.classList.add('selected');
        document.querySelector('.chapter-info').textContent = item.textContent;

        // console.log('selectIndex：' + selectIndex);

    }


    function readEl(el, startIndex) {
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
        }
        setPlaylbl(true);
        var lineIndex = 0;
        var lineTxt = null;
        var html = el.innerHTML;
        var txt = el.innerText;

        var speakTxt = txt;
        if (startIndex != 0) speakTxt = speakTxt.substring(startIndex);
        /**
            婷婷
        */
        // var voiceName = 'Microsoft Xiaoxiao Online (Natural) - Chinese (Mainland)';
        var voiceName = 'Xiaoxiao';
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
        if (isIOS) voiceName = '婷婷';

        utterance = new SpeechSynthesisUtterance(speakTxt);
        utterance.lang = 'zh-CN';
        utterance.voice = speechSynthesis.getVoices().find(voice => voice.name.includes(voiceName));
        utterance.rate = 1.5; // 设置朗读速度为最大

        var tipStr = "";
        speechSynthesis.getVoices().forEach(function (voice) {
            if (voice.lang != 'zh-CN') return;
            tipStr += voice.name + "\n";
            console.log(voice.name);
        })

        var tipInfo = document.getElementsByClassName("tip-info")[0];
        tipInfo.innerText = tipStr;

        utterance.onboundary = (event) => {

            let start = event.charIndex + startIndex;
            let len = event.charLength;
            let end = start + len;
            let word = txt.substring(start, end);
            el.innerHTML = txt.substring(0, start) + `<span class="highlight">${word}</span>` + txt.substring(end);

            var keywordSpan = el.querySelector('.highlight');
            var range = document.createRange();
            range.setStart(keywordSpan, 0);
            range.setEnd(keywordSpan, 1);
            var selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            selection.modify('move', 'backward', 'lineboundary');
            selection.modify('extend', 'forward', 'lineboundary');
            let _lineTxt = selection.toString();

            var startTxt = txt.substring(0, lineIndex);
            var endTxt = txt.substring(lineIndex);
            var newTxt = startTxt + endTxt.replace(_lineTxt, `<span class="line-selection">${_lineTxt}</span>`);

            if (lineTxt == null) lineTxt = _lineTxt;
            if (lineTxt != _lineTxt) {
                lineIndex = endTxt.indexOf(lineTxt) + lineTxt.length;
                lineTxt = _lineTxt;
            }

            var _lineIndex = lineIndex + (endTxt.indexOf(lineTxt) + lineTxt.length);
            if (end > lineIndex + (endTxt.indexOf(lineTxt) + lineTxt.length)) {
                word = word.substring(0, word.length - (end - _lineIndex));
            }
            // console.log('word:' + word + '  end: ' + end + '  lineIndex: ' + _lineIndex);
            var lineLen = `<span class="line-selection">`.length;
            var lineHtml = newTxt.substring(0, start + lineLen) + `<span class="highlight">${word}</span>` + newTxt.substring(start + lineLen + word.length);
            el.innerHTML = lineHtml;

            // console.log(_lineTxt);
            // console.log(lineHtml);
            // console.log(lineTxt);
        };
        utterance.onend = () => {
            el.innerHTML = txt;
            playIndex++;
            if (playIndex >= textNodes.length) {
                return;
            }
            readEl(textNodes[playIndex].parentElement, 0);
        };
        speechSynthesis.speak(utterance);
    }

</script>

<body>
    <div class="file-input-div">
        <div>
            <div style="align-items: center;justify-content: center;text-align: center;">
                <label class="lbldisplay">
                    <input class="display-type" type="radio" name="option" value="1" checked="true"
                        onclick="switchDisplay()"> 默认显示</label>
                <label class="lbldisplay">
                    <input class="display-type" type="radio" name="option" value="2" onclick="switchDisplay()">
                    双栏显示&nbsp;&nbsp;&nbsp;&nbsp;|</label>
                &nbsp;
                <label> <input class="display-type" type="radio" name="option2" value="1" checked="true"
                        onclick="switchTheme()"> 默认主题</label>
                <label> <input class="display-type" type="radio" name="option2" value="2" onclick="switchTheme()">
                    暗黑主题</label>
            </div>
            <div class="custom-file-input">
                <input type="file" id="real-input" title="">
                <div class="custom-file-label">
                    <span class="file-name"></span>
                </div>
            </div>
            <div style="text-align: center;">
                <br />
                <br />
                <a href="https://convertio.co/zh/epub-txt/">在线 epub 转 txt</a>
            </div>
        </div>
    </div>

    <div class="main-div">
        <div class="padviewer">
            <div class="reader-container">
                <div class="content"></div>
            </div>
            <div class="page-tip"></div>
            <div class="page-index"></div>
        </div>
        <!-- <div class="page-title"></div> -->
    </div>
    <div class="viewer"></div>


    <div>
        <div class="default-bar">
            <button class="play-btn" style="display: none;">播 放</button>
            <div class="chapter-info" onclick="toggleDetail()">--</div>
            <div class="play-pos" onclick="playPos()" title="直达播放位置">···</div>
        </div>

        <div class="book-container" id="bookDetail">
            <div class="book-title"></div>
            <ul class="chapter-list"></ul>
        </div>
    </div>

    <div class="tip-info" style="display: none;"></div>



</body>

</html>
